name: Terraform + SAST + Docker Compose Deploy

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  cicd:
    runs-on: ubuntu-latest

    steps:
    # ------------------- Checkout Code -------------------
      - name: Checkout code
        uses: actions/checkout@v4

    # ------------------- Configure AWS (OIDC) -------------------
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_SHUBH }}
          aws-region: us-west-1

    # ------------------- Terraform -------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: terraform
        run: terraform init -reconfigure

      - name: Terraform Plan
        working-directory: terraform
        run: terraform plan -out=tfplan -lock-timeout=5m

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve tfplan

      - name: Get Terraform Outputs
        id: tf
        working-directory: terraform
        run: |
          echo "EC2_IP=$(terraform output -raw instance_public_ip)" >> $GITHUB_OUTPUT
          echo "ECR_URI=$(terraform output -raw ecr_repository_url)" >> $GITHUB_OUTPUT

      - name: Debug Terraform Outputs
        run: |
          echo "Terraform EC2 IP: ${{ steps.tf.outputs.EC2_IP }}"
          echo "Terraform ECR URI: ${{ steps.tf.outputs.ECR_URI }}"

    # ------------------- SonarQube (SAST â€“ CORRECT WAY) -------------------
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

    # ------------------- Docker Build -------------------
      - name: Login to AWS ECR
        run: |
          aws ecr get-login-password --region us-west-1 | \
          docker login --username AWS --password-stdin ${{ steps.tf.outputs.ECR_URI }}

      - name: Build Docker Image
        run: |
          docker compose build
          docker tag react-app-sast-react-app:latest ${{ steps.tf.outputs.ECR_URI }}:latest

    # ------------------- Trivy (IMAGE SCAN) -------------------
      - name: Scan Docker Image with Trivy
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v $GITHUB_WORKSPACE:/workspace \
            aquasec/trivy:latest image \
            --severity HIGH,CRITICAL \
            --exit-code 1 \
            --format json \
            --output /workspace/trivy-report.json \
            ${{ steps.tf.outputs.ECR_URI }}:latest

      - name: Upload Trivy Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.json

      - name: Push Docker Image to ECR
        run: |
          docker push ${{ steps.tf.outputs.ECR_URI }}:latest

    # ------------------- SSH Deploy to EC2 -------------------
      - name: Setup SSH for Terraform EC2
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.MYKEY_SHUBH }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ steps.tf.outputs.EC2_IP }} >> ~/.ssh/known_hosts

      - name: Deploy App Container
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ steps.tf.outputs.EC2_IP }} << 'EOF'
            set -e
            aws ecr get-login-password --region us-west-1 \
            | docker login --username AWS --password-stdin ${{ steps.tf.outputs.ECR_URI }}
            docker pull ${{ steps.tf.outputs.ECR_URI }}:latest
            docker stop my-reactapp || true
            docker rm my-reactapp || true
            docker run -d \
              --restart always \
              --name my-reactapp \
              -p 80:80 \
              ${{ steps.tf.outputs.ECR_URI }}:latest
          EOF

# name: Terraform + SAST + Docker Compose Deploy

# on:
#   push:
#     branches:
#       - main

# permissions:
#   id-token: write
#   contents: read

# jobs:
#   cicd:
#     runs-on: ubuntu-latest

#     steps:
#     # ------------------- Checkout Code -------------------
#       - name: Checkout code
#         uses: actions/checkout@v4

#     # ------------------- Configure AWS (OIDC) -------------------
#       - name: Configure AWS credentials (OIDC)
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           role-to-assume: ${{ secrets.AWS_ROLE_ARN_SHUBH }}
#           aws-region: us-west-1

#     # ------------------- Terraform -------------------
#       - name: Setup Terraform
#         uses: hashicorp/setup-terraform@v3

#       - name: Terraform Init
#         working-directory: terraform
#         run: terraform init -reconfigure

#       - name: Terraform Plan
#         working-directory: terraform
#         run: terraform plan -out=tfplan -lock-timeout=5m

#       - name: Terraform Apply
#         working-directory: terraform
#         run: terraform apply -auto-approve tfplan

#       - name: Get Terraform Outputs
#         id: tf
#         working-directory: terraform
#         run: |
#           echo "EC2_IP=$(terraform output -raw instance_public_ip)" >> $GITHUB_OUTPUT
#           echo "ECR_URI=$(terraform output -raw ecr_repository_url)" >> $GITHUB_OUTPUT

#       - name: Debug Terraform Outputs
#         run: |
#           echo "Terraform EC2 IP: ${{ steps.tf.outputs.EC2_IP }}"
#           echo "Terraform ECR URI: ${{ steps.tf.outputs.ECR_URI }}"

#     # ------------------- SonarQube -------------------
#       - name: Setup SSH for SonarQube EC2
#         run: |
#           if [ -z "${{ secrets.SONAR_EC2_IP }}" ]; then
#             echo "Error: SONAR_EC2_IP is empty!"
#             exit 1
#           fi
#           mkdir -p ~/.ssh
#           echo "${{ secrets.SONAR_EC2_KEY }}" > ~/.ssh/id_rsa
#           chmod 600 ~/.ssh/id_rsa
#           ssh-keyscan -H ${{ secrets.SONAR_EC2_IP }} >> ~/.ssh/known_hosts

#       - name: Run SonarQube Scan via Docker on EC2
#         run: |
#           ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.SONAR_EC2_IP }} << EOF
#             docker run --rm --network host \
#               -v /home/ubuntu/sonarqube:/usr/src \
#               sonarsource/sonar-scanner-cli \
#               -Dsonar.projectKey=cn-web \
#               -Dsonar.sources=. \
#               -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
#               -Dsonar.login=${{ secrets.SONAR_TOKEN }}
#           EOF

#     # ------------------- Docker Build & Scan -------------------
#       - name: Login to AWS ECR
#         run: |
#           aws ecr get-login-password --region us-west-1 | \
#           docker login --username AWS --password-stdin ${{ steps.tf.outputs.ECR_URI }}

#       - name: Build Docker Image
#         run: |
#           docker compose build
#           IMAGE_URI=${{ steps.tf.outputs.ECR_URI }}:latest
#           docker tag react-app-sast-react-app:latest $IMAGE_URI

#       - name: Scan Docker Image with Trivy (Official Docker)
#         run: |
#           docker run --rm \
#             -v /var/run/docker.sock:/var/run/docker.sock \
#             -v $GITHUB_WORKSPACE:/workspace \
#             aquasec/trivy:latest image \
#             --severity HIGH,CRITICAL \
#             --exit-code 1 \
#             --format json \
#             --output /workspace/trivy-report.json \
#             ${{ steps.tf.outputs.ECR_URI }}:latest

#       - name: Upload Trivy Report
#         uses: actions/upload-artifact@v4
#         with:
#           name: trivy-report
#           path: trivy-report.json

#       - name: Push Docker Image to ECR
#         run: |
#           docker push ${{ steps.tf.outputs.ECR_URI }}:latest

#     # ------------------- SSH Deploy to EC2 -------------------
#       - name: Setup SSH for Terraform EC2
#         run: |
#           if [ -z "${{ steps.tf.outputs.EC2_IP }}" ]; then
#             echo "Error: EC2_IP is empty!"
#             exit 1
#           fi
#           mkdir -p ~/.ssh
#           echo "${{ secrets.MYKEY_SHUBH }}" > ~/.ssh/id_rsa
#           chmod 600 ~/.ssh/id_rsa
#           ssh-keyscan -H ${{ steps.tf.outputs.EC2_IP }} >> ~/.ssh/known_hosts

#       - name: Deploy App Container
#         run: |
#           ssh -i ~/.ssh/id_rsa ubuntu@${{ steps.tf.outputs.EC2_IP }} << 'EOF'
#             set -e
#             # Login to ECR on EC2
#             aws ecr get-login-password --region us-west-1 \
#             | docker login --username AWS --password-stdin ${{ steps.tf.outputs.ECR_URI }}
#             # Pull latest image
#             docker pull ${{ steps.tf.outputs.ECR_URI }}:latest
#             # Stop and remove old container
#             docker stop my-reactapp || true
#             docker rm my-reactapp || true
#             # Run new container with restart policy
#             docker run -d \
#               --restart always \
#               --name my-reactapp \
#               -p 80:80 \
#               ${{ steps.tf.outputs.ECR_URI }}:latest
#           EOF


